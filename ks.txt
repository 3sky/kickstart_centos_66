# Kickstart file automatically generated by anaconda.

#version=DEVEL
install
harddrive --partition=LABEL=CENTOS --dir=/
lang en_US.UTF-8
keyboard pl2
network --onboot no --device eth0 --bootproto static --ip 192.168.0.254 -- netmask 255.255.255.0 -noipv6 --hostname server1
rootpw  --iscrypted $6$fG.7pyAtmYbfrECF$L.LizRlvdKp63JHildXxEm53FT0N0Hd4CPKXu4jrun6yAKjSsCOWe.pqAntAlDfs8HFvY50FYkCn74pYGPDRZ.
firewall --service=ssh
#firewall --disabled
selinux --disabled
services --disabled=kdump
authconfig --enableshadow --passalgo=sha512
selinux --enforcing
timezone --utc Europe/Warsaw
bootloader --location=mbr --driveorder=vda --append="crashkernel=auto rhgb quiet"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work


clearpart --all --drives=vda
part /boot --fstype=ext4 --size=500
part pv.253002 --grow --size=1
volgroup vg_test --pesize=4096 pv.253002
logvol / --fstype=ext4 --name=lv_root --vgname=vg_test --grow --size=1024 --maxsize=51200
logvol swap --name=lv_swap --vgname=vg_test --grow --size=1024 --maxsize=1024

repo --name="CentOS" --baseurl=file:///mnt/source --cost=100  

%packages 
@core
@base
dhcp
tftp-server
syslinux
httpd
tftp
dnsmasq
-biosdevname
# post install scripts
%post
cat <<EOF > /etc/sysconfig/network-scripts/ifcfg-eth0 
DEVICE="eth0"
BOOTPROTO="dhcp"
ONBOOT="yes"
TYPE="Ethernet"
EOF
cat <<EOF > /etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE="eth1"
ONBOOT="yes"
BOOTPROTO="static"
TYPE="Ethernet"
IPADDR="192.168.0.254"
EOF
echo DHCPDARGS=\"eth1\" > /etc/sysconfig/dhcpd
cat <<EOF > /etc/dhcp/dhcpd.conf 
log-facility local7;
allow booting;
allow bootp;
option option-128 code 128 = string;
option option-129 code 129 = text;
next-server 192.168.0.254;
filename "/pxelinux.0";
local-address 192.168.0.254;

subnet 192.168.0.0 netmask 255.255.255.0 {
  range 192.168.0.10 192.168.0.50;
  option domain-name "example.com";
  option routers 192.168.0.254;
  option domain-name-servers 192.168.0.254;
  option subnet-mask 255.255.255.0;
  option broadcast-address 192.168.0.255;
}
EOF
cat <<EOF > /etc/vsftpd/vsftpd.conf
anonymous_enable=YES
anon_root=/var/lib/tftpboot/images
local_enable=YES
write_enable=YES
local_umask=022
dirmessage_enable=YES
xferlog_enable=YES
connect_from_port_20=YES
xferlog_std_format=YES
listen=YES
pam_service_name=vsftpd
userlist_enable=YES
tcp_wrappers=YES
EOF
#(notatka) 
mkdir -p /var/www/html/repo
mount -o loop,ro LABEL=CETNOS /mnt 
rsync -Pav /mnt/  /var/www/html/repo/
umount /mnt/
cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/
cp /usr/share/syslinux/chain.c32 /var/lib/tftpboot/
cp /usr/share/syslinux/menu.c32 /var/lib/tftpboot/
cp /usr/share/syslinux/memdisk /var/lib/tftpboot/
cp /usr/share/syslinux/mboot.c32 /var/lib/tftpboot/
mkdir /var/lib/tftpboot/pxelinux.cfg
mkdir /var/lib/tftpboot/centos66
cp -vr /var/www/html/repo/images/pxeboot/initrd.img /var/lib/tftpboot/centos66/
cp -vr /var/www/html/repo/images/pxeboot/vmlinuz /var/lib/tftpboot/centos66/
cat << EOF > /var/lib/tftpboot/pxelinux.cfg/default
DEFAULT menu.c32
PROMPT 0
TIMEOUT 300
ONTIMEOUT localdisk

MENU TITLE PXE Network Boot

LABEL localdisk
        MENU LABEL ^Local Hard Drive
        MENU DEFAULT
        LOCALBOOT 0
LABEL install cetnos66
        MENU Label ^CentOS 6.6  Install
        KERNEL centos66/vmlinuz
        APPEND initrd=centos66/initrd.img ramdisk_size=1024  method=http://192.168.0.254/repo lang=us 
LABEL install cetnos66 via kickstart
        MENU Label ^Kickstart Install
        KERNEL centos66/vmlinuz
        APPEND initrd=centos66/initrd.img ramdisk_size=1024  method=http://192.168.0.254/repo ks=http://192.168.0.254/repo/ks/ks_n.cfg  lang=us text
EOF
cat << EOF > /etc/xinetd.d/tftp
service tftp
{
        disable                 = no
        socket_type             = dgram
        protocol                = udp
        wait                    = yes
        user                    = root
        server                  = /usr/sbin/in.tftpd
        server_args             = -s /var/lib/tftpboot
        per_source              = 11
        cps                     = 100 2
        flags                   = IPv4
}
EOF
cat << EOF > /etc/sysconfig/selinux 
SELINUX=disabled
SELINUXTYPE=targeted
EOF
iptables -I INPUT -m state --state NEW -p udp --dport 69 -j ACCEPT
iptables -I INPUT -m state --state NEW -p tcp --dport 80 -j ACCEPT
#iptables -I INPUT -m state --state NEW -p tcp --dport 21 -j ACCEPT
iptables -t nat -A POSTROUTING -j MASQUERADE
chkconfig dhcpd on
chkconfig tftp on
chkconfig httpd on
chkconfig vsftpd on
